#!/usr/bin/env python3
"""
Continuous import watcher with TUI interface.

Watches the import directory and automatically processes files with AI.
"""
import sys
import curses
import time
from pathlib import Path
from datetime import datetime

# Add src to path
sys.path.insert(0, str(Path(__file__).parent / "src"))

from import_processor import ImportProcessor, create_import_dir_readme


# Color pairs
COLOR_HEADER = 1
COLOR_ACTIVE = 2
COLOR_SUCCESS = 3
COLOR_WARNING = 4
COLOR_ERROR = 5


def init_colors():
    """Initialize color pairs"""
    curses.start_color()
    curses.use_default_colors()

    curses.init_pair(COLOR_HEADER, curses.COLOR_CYAN, -1)
    curses.init_pair(COLOR_ACTIVE, curses.COLOR_YELLOW, -1)
    curses.init_pair(COLOR_SUCCESS, curses.COLOR_GREEN, -1)
    curses.init_pair(COLOR_WARNING, curses.COLOR_YELLOW, -1)
    curses.init_pair(COLOR_ERROR, curses.COLOR_RED, -1)


def draw_progress_bar(width: int, percent: int) -> str:
    """Draw an ASCII progress bar"""
    filled = int((width * percent) / 100)
    bar = "â–ˆ" * filled + "â–‘" * (width - filled)
    return f"[{bar}] {percent}%"


def watch_imports_loop(stdscr):
    """Main TUI loop for watching imports"""
    # Initialize
    curses.curs_set(0)  # Hide cursor
    init_colors()

    projects_dir = Path.home() / "projects"
    import_dir = projects_dir / "import"

    # Ensure directories exist
    import_dir.mkdir(parents=True, exist_ok=True)
    readme_path = import_dir / "README.md"
    if not readme_path.exists():
        create_import_dir_readme(import_dir)

    processor = ImportProcessor(import_dir, projects_dir)

    # State
    last_check = time.time()
    check_interval = 10  # Check every 10 seconds
    processing_file = None
    processing_progress = 0
    total_processed = 0
    last_results = []
    status_message = "Waiting for files..."

    # Main loop
    while True:
        stdscr.clear()
        height, width = stdscr.getmaxyx()

        # === HEADER ===
        title = "MISSION CONTROL - AUTO-IMPORT WATCHER"
        try:
            stdscr.addstr(0, (width - len(title)) // 2, title,
                         curses.color_pair(COLOR_HEADER) | curses.A_BOLD)
            stdscr.addstr(1, 0, "â•" * width, curses.color_pair(COLOR_HEADER))
        except curses.error:
            pass

        # === STATUS SECTION ===
        y = 3
        try:
            # Current time
            current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            stdscr.addstr(y, 2, f"Time: {current_time}")
            y += 1

            # Watch directory
            stdscr.addstr(y, 2, f"Watching: {import_dir}")
            y += 1

            # Check interval
            time_since_check = int(time.time() - last_check)
            next_check = max(0, check_interval - time_since_check)
            stdscr.addstr(y, 2, f"Next check in: {next_check}s")
            y += 2

            # Total processed
            stdscr.addstr(y, 2, f"Total Processed: {total_processed} file(s)",
                         curses.color_pair(COLOR_SUCCESS) | curses.A_BOLD)
            y += 2

        except curses.error:
            pass

        # === PROCESSING STATUS ===
        try:
            stdscr.addstr(y, 2, "â”€" * (width - 4))
            y += 1

            if processing_file:
                # Currently processing
                stdscr.addstr(y, 2, "ðŸ¤– PROCESSING",
                             curses.color_pair(COLOR_ACTIVE) | curses.A_BOLD)
                y += 2

                # File name
                stdscr.addstr(y, 4, f"File: {processing_file}",
                             curses.color_pair(COLOR_ACTIVE))
                y += 2

                # Progress bar
                bar = draw_progress_bar(40, processing_progress)
                stdscr.addstr(y, 4, bar, curses.color_pair(COLOR_ACTIVE))
                y += 2

            else:
                # Idle status
                stdscr.addstr(y, 2, "ðŸ“¥ STATUS",
                             curses.color_pair(COLOR_HEADER) | curses.A_BOLD)
                y += 2

                stdscr.addstr(y, 4, status_message)
                y += 2

        except curses.error:
            pass

        # === RECENT RESULTS ===
        if last_results:
            try:
                stdscr.addstr(y, 2, "â”€" * (width - 4))
                y += 1

                stdscr.addstr(y, 2, "ðŸ“Š LAST IMPORT RESULTS",
                             curses.color_pair(COLOR_HEADER) | curses.A_BOLD)
                y += 2

                for result in last_results[-3:]:  # Show last 3
                    stdscr.addstr(y, 4, f"âœ“ {result['filename']}",
                                 curses.color_pair(COLOR_SUCCESS))
                    y += 1

                    if result.get('tasks'):
                        stdscr.addstr(y, 6, f"Tasks: {result['tasks']}  "
                                           f"Decisions: {result['decisions']}  "
                                           f"Updates: {result['updates']}")
                        y += 1

                    if result.get('projects'):
                        projects_str = ', '.join(result['projects'][:3])
                        if len(result['projects']) > 3:
                            projects_str += f" (+{len(result['projects']) - 3} more)"
                        stdscr.addstr(y, 6, f"Projects: {projects_str}")
                        y += 1

                    y += 1

            except curses.error:
                pass

        # === FOOTER ===
        try:
            footer_y = height - 2
            stdscr.addstr(footer_y, 0, "â”€" * width, curses.color_pair(COLOR_HEADER))
            stdscr.addstr(footer_y + 1, 2,
                         "[q] Quit  [r] Refresh Now  [c] Clear Results",
                         curses.color_pair(COLOR_HEADER))
        except curses.error:
            pass

        stdscr.refresh()

        # === AUTO-CHECK LOGIC ===
        current_time = time.time()
        if current_time - last_check >= check_interval and not processing_file:
            last_check = current_time

            # Scan for files
            import_files = processor.scan_import_directory()

            if import_files:
                # Process files
                for import_file in import_files:
                    processing_file = import_file.filename
                    processing_progress = 0
                    stdscr.refresh()

                    try:
                        # Simulate progress
                        for progress in [10, 25, 50, 75, 90]:
                            processing_progress = progress
                            stdscr.clear()
                            # Re-render (simplified)
                            stdscr.addstr(height // 2 - 2, (width - 40) // 2,
                                         f"Processing: {processing_file[:40]}",
                                         curses.color_pair(COLOR_ACTIVE) | curses.A_BOLD)
                            bar = draw_progress_bar(40, processing_progress)
                            stdscr.addstr(height // 2, (width - 50) // 2, bar,
                                         curses.color_pair(COLOR_ACTIVE))
                            stdscr.refresh()
                            time.sleep(0.2)

                        # Actually process with AI
                        summary = processor.process_all(use_ai=True, stage_for_review=True)

                        processing_progress = 100
                        total_processed += summary['analyzed']

                        # Store results
                        if summary['results']:
                            last_results.extend(summary['results'])

                        status_message = f"âœ“ Processed {summary['analyzed']} file(s) - staged for review"

                    except Exception as e:
                        status_message = f"âœ— Error: {str(e)[:60]}"

                    finally:
                        processing_file = None
                        processing_progress = 0

                        # Show completion briefly
                        stdscr.clear()
                        stdscr.addstr(height // 2, (width - 40) // 2,
                                     "âœ“ Import Complete - Files Archived",
                                     curses.color_pair(COLOR_SUCCESS) | curses.A_BOLD)
                        stdscr.refresh()
                        time.sleep(1)

            else:
                status_message = "No files detected - drop files to import directory"

        # === INPUT HANDLING ===
        stdscr.timeout(100)  # 100ms timeout
        try:
            key = stdscr.getch()

            if key == ord('q') or key == ord('Q'):
                break
            elif key == ord('r') or key == ord('R'):
                # Force immediate check
                last_check = 0
            elif key == ord('c') or key == ord('C'):
                # Clear results
                last_results = []

        except KeyboardInterrupt:
            break


def main():
    """Entry point"""
    try:
        curses.wrapper(watch_imports_loop)
    except KeyboardInterrupt:
        print("\nStopped import watcher")
        sys.exit(0)


if __name__ == "__main__":
    main()
